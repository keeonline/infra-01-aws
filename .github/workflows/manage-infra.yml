name: Manage infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        type: choice
        description: Terraform action
        required: true
        options:
          - apply-plan
          - apply
          - destroy-plan
          - destroy
        default: apply-plan
      environment:
        type: environment
        description: The targeted GitHub environment
        required: false
        default: test

jobs:
  manage-resources:
    name: Manage resources
    runs-on: ubuntu-24.04
    environment: ${{inputs.environment}}
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Get the artefact version values
        id: versions
        # uses: keeonline/github-actions/artefact-version-by-ref-type@v0.0.8
        uses: keeonline/github-actions/artefact-version@feature-1

      - name: show versions
        run: |
          echo "branch-version=${{steps.versions.outputs.branch}}"
          echo "current-semantic=${{steps.versions.outputs.current_semantic}}"
          echo "next-semantic=${{steps.versions.outputs.next_semantic}}"

      - name: Set the infra version
        id: infra_version
        shell: bash
        run: |
          if [ "${{ github.ref_type }}" == "branch" ]
          then
            echo "${{steps.versions.outputs.branch}} >> $GITHUB_OUTPUT"
          else
            echo "${{github.ref_name}} >> $GITHUB_OUTPUT"
          fi

      # - name: terraform action
      #   uses: keeonline/github-actions/terraform-action@v0.0.8
      #   env:
      #     TF_VAR_infra_environment: ${{inputs.environment}}
      #     TF_VAR_infra_version: ${{steps.infra_version.outputs.version}}
      #   with:
      #     aws_account_id: ${{secrets.AWS_ACCOUNT_ID}}
      #     aws_region: ${{secrets.AWS_REGION}}
      #     action: ${{inputs.action}}
      #     terraform_codedir: terraform/core
      #     environment: ${{inputs.environment}}
